# dsc180a_capstone_project

This program takes care of all data loading and preprocessing, model building and training, and visualizations regarding our DSC 180 Capstone project.

## Usage
All functionality is used by running `python3 run.py` followed by some arguments in the root directory. The first argument is `exec_type` which indicates what action you would like to take. Possible values are:
```
data     # for data loading

train    # for model training

OT       # for optimal transport

eval     # for gathering results

viz      # for creating visualizations

all      # for doing all of the above

test     # for testing all of the above on dummy data
         # (except downloading the data)
```

The second and final argument is `-c` or `--clean`, which, when included cleans the save directories used by the specified `exec_type`.

### All
The `all` function runs the other functions sequentially, so you don't have to run each individual function. It is up to the user to set values in the `config/` files correctly. To run:
```bash
python3 run.py all
```

To remove all models, OT, results, and visualizations generated by the program, run:
```bash
python3 run.py all -c    # or --clean
```
Note: running this will NOT remove the 13.1 GB of data downloaded by running the `data` function. This is to prevent headache on behalf of the user. You're welcome.

### Data Loading
The dataset is downloaded from the WILDS project using their python package, which is a prerequisite. To install run:
```bash
pip install wilds
```

Running the following command in the root project directory will download the dataset to the proper location:
```bash
python3 run.py data
```

### Model Training
The model we used for this project was a custom CNN built in pytorch and trained entirely on either urban or rural data from one country. To train a model with settings specified in the `config/train.json`, run:
```bash
python3 run.py train
```
To change which country the model should be trained on, whether an urban/rural model should be trained, the percentile cutoffs the model uses for classification, or other training parameters, please consult the config section below.

To remove all trained models, run:
```bash
python3 run.py train -c    # or --clean
```

### Optimal Transport
Optimal transport was achieved using the python optimal transport package, which is a prerequisite. To install run:
```bash
pip install ot
```

In our implementation, optimal transport is used for domain adaptation. The goal is to adapt the color profiles of one country to another, in the hope that the CNN trained on only one country can more accurately classify images from another country.
In order to fit the optimal transport to transport images from a source country to a target country, first edit the source and target country fields in `config/OT.json`, then run:
```bash
python3 run.py OT
```

To remove all saved OT models, run:
```bash
python3 run.py OT -c    # or --clean
```

### Results
The results are gathered and using data, models and OT objects saved from above. This function will error if run without running `data`, `train`, and `OT` first with aligning configuration to generate objects. To run:
```bash
python3 run.py eval
```

To remove all saved results, run:
```bash
python3 run.py eval -c    # or --clean
```

### Visulizations
Similarly to results, the `viz` function requires previous data to be present in the directories specified in each `config/` file. Visualizations are generated using matplotlib and pandas, both prerequisites. To run:
```bash
python3 run viz
```

To remove all saved visualizations, run:
```bash
python3 run.py viz -c    # or --clean
```

### Test
The `test` function is similar to the `all` function except it uses randomly generated data. A valid `config/` is still required for the program to run entirely. And onjects will still be saved. To run:
```bash
python3 run.py test -c    # or --clean
```

Running `python3 run.py test -c    # or --clean` won't remove anything. To remove all saved objects, run:
```bash
python3 run.py all -c    # or --clean
```

## Config
Below is the default `config/` files along with descriptions of each option.

### Train
`config/train.json`

```json
{
    "country": "nigeria",  // the country to train the model on (usually same as "target_country")
    "train_proportion": 0.7,  // proportion of data to use to train the model
    "valid_proportion": 0.2,   // proportion of data to use to validate the model
    "urban": true,  // whether to train a model on urban data
    "rural": true,  // whether to train a rural on urban data
    "low_quantile": 0.3333333,  // the lower percentile used for classification cutoff
    "high_quantile": 0.6666666,  // the lower percentile used for classification cutoff
    "n_epochs": 300,   // number of epochs to train the model on (best one will be used for evaluation)
    "batch_size": 48,  // batch size to use
    "save_path": "models/",  // path to save models at
    "random_seed": 10  // random seed to use for training
}
```

### OT
`config/OT.json`

```json
{
    "target_country": "nigeria",  // country to transport to
    "source_country": "mali",  // country to transport from
    "n_samples": 500,  // number of pixel samples to take from each country
    "reg": 0.1,  // sinkhorn's regularization parameter
    "batch_size": 10,  // batch size to use for OT
    "save_path": "OT/",  // path to save OT objects to
    "random_seed": 10  // random seed to use for OT
}
```

### Results
`config/eval.json`

```json
{
    "target_country": "nigeria", // OT "target_country" (usually the same as "country" in config/train.json)
    "source_country": "mali",  // OT "source_country"
    "urban": true,  // whether to evaluate results on urban model
    "rural": true,  // whether to evaluate results on rural model
    "batch_size": 10,  // batch size to use when evaluating
    "save_path": "results/",  // path to save results at
    "random_seed": 76  // random seed to use for evaluation
}
```

### Visualizations
`config/viz.json`

```json
{
    "asset_index_dist": true,  // whether to show asset index distribution visualization
    "clf_cutoffs": true,  // whether to show classification cutoff visualization
    "target_country": "nigeria",  // OT "target_country" and train "country"
    "source_country": "mali",  // OT "source_country"
    "low_quantile": 0.33333,  // the lower percentile used for classification cutoff
    "high_quantile": 0.66666,  // the lower percentile used for classification cutoff
    "training_info": {
        "urban": true,  // whether to show training info for urban model
        "rural": true  // whether to show training info for rural model
    },
    "source_confusion_matrix": {
        "urban": {
            "without_OT": true,  // whether to show confusion matrix for urban model without OT
            "with_OT": true  // whether to show confusion matrix for urban model with OT
            
        },
        "rural": {
            "without_OT": true,  // whether to show confusion matrix for rural model without OT
            "with_OT": true  // whether to show confusion matrix for rural model with OT
        }
    },
    "show_changed": true,  // whether to an example of where optimal transport changed the models prediction
    "save_path": "viz/", // path to save visualizations to
    "random_seed": 53 // random seed to use for visualizations
}
```
